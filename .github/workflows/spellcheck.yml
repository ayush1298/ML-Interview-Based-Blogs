name: Spellcheck

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  spellcheck:
    name: Spellcheck Markdown Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better change detection

      - name: Setup Python for filename checking
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check filenames for spelling
        id: check_filenames
        run: |
          echo "Checking markdown filenames for spelling..."
          python << 'EOF'
          import os
          import re
          import sys
          
          # Load wordlist
          wordlist = set()
          if os.path.exists('.wordlist.txt'):
              with open('.wordlist.txt', 'r', encoding='utf-8') as f:
                  for line in f:
                      word = line.strip().lower()
                      if word and not word.startswith('#'):
                          wordlist.add(word)
          
          # Common technical terms that might be in filenames
          technical_terms = {
              'llm', 'cnn', 'rnn', 'lstm', 'bert', 'gpt', 'rag', 'vlm', 
              'fsd', 'nms', 'cuda', 'oom', 'ttft', 'moe', 'lora', 'ppo', 'dpo',
              'api', 'url', 'html', 'css', 'json', 'yaml'
          }
          wordlist.update(technical_terms)
          
          errors = []
          # Find all .md files
          for root, dirs, files in os.walk('.'):
              # Skip hidden directories and build directories
              dirs[:] = [d for d in dirs if not d.startswith('.') and d not in ['node_modules', 'website/_site']]
              
              for file in files:
                  if file.endswith('.md'):
                      filepath = os.path.join(root, file)
                      # Extract words from filename (remove extension, split by spaces/special chars)
                      filename_no_ext = file[:-3]  # Remove .md
                      # Split by common separators
                      words = re.findall(r'[a-zA-Z]+', filename_no_ext.lower())
                      
                      for word in words:
                          # Skip very short words
                          if len(word) < 3:
                              continue
                          # Check if word is in wordlist or is a number
                          if word not in wordlist and not word.isdigit():
                              # Check if it's a common word (basic check)
                              if word not in ['the', 'and', 'for', 'are', 'but', 'not', 'you', 'all', 'can', 'her', 'was', 'one', 'our', 'out', 'day', 'get', 'has', 'him', 'his', 'how', 'its', 'may', 'new', 'now', 'old', 'see', 'two', 'way', 'who', 'boy', 'did', 'use', 'she', 'use', 'man', 'say', 'she', 'use', 'her', 'many', 'than', 'call', 'first', 'water', 'been', 'find', 'more', 'very', 'what', 'know', 'just', 'name', 'good', 'make', 'time', 'year', 'work', 'take', 'come', 'think', 'look', 'want', 'give', 'need', 'long', 'show', 'move', 'play', 'turn', 'start', 'might', 'learn', 'being', 'leave', 'seem', 'help', 'talk', 'turn', 'start', 'right', 'move', 'play', 'turn', 'start', 'might', 'learn', 'being', 'leave', 'seem', 'help', 'talk', 'turn', 'start', 'right', 'move', 'play', 'turn', 'start', 'might', 'learn', 'being', 'leave', 'seem', 'help', 'talk', 'turn', 'start', 'right', 'move', 'play', 'turn', 'start', 'might', 'learn', 'being', 'leave', 'seem', 'help', 'talk', 'turn', 'start', 'right']:
                                  errors.append(f"âš ï¸  Potential spelling issue in filename: {filepath} (word: '{word}')")
          
          if errors:
              print("\n".join(errors))
              print(f"\nâŒ Found {len(errors)} potential spelling issues in filenames")
              print("ðŸ’¡ Tip: Add technical terms to .wordlist.txt if they are correct")
              sys.exit(1)
          else:
              print("âœ… All filenames passed spelling check")
          EOF

      - name: Spellcheck file contents
        uses: rojopolis/spellcheck-github-actions@0.58.0
        with:
          task_name: Markdown
          config_path: .spellcheck.yml
          source_files: |
            "**/*.md"
            "!node_modules/**"
            "!website/_site/**"
            "!.github/**"

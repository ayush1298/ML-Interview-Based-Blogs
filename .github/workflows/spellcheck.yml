name: Spellcheck

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  spellcheck:
    name: Spellcheck Markdown Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better change detection

      - name: Setup Python for filename checking
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install spellchecker library
        run: |
          pip install pyspellchecker

      - name: Check filenames for spelling
        id: check_filenames
        run: |
          echo "Checking markdown filenames for spelling..."
          python << 'EOF'
          import os
          import re
          import sys
          from spellchecker import SpellChecker
          
          # Initialize spell checker with English dictionary (includes ~100k words)
          spell = SpellChecker(language='en')
          
          # Load custom wordlist for technical terms (add to dictionary)
          technical_terms = set()
          if os.path.exists('.wordlist.txt'):
              with open('.wordlist.txt', 'r', encoding='utf-8') as f:
                  for line in f:
                      word = line.strip().lower()
                      if word and not word.startswith('#'):
                          technical_terms.add(word)
                          # Add to spell checker's known words
                          spell.word_frequency.load_words([word])
          
          # Add common technical acronyms (case-insensitive)
          common_acronyms = {
              'llm', 'cnn', 'rnn', 'lstm', 'bert', 'gpt', 'rag', 'vlm', 
              'fsd', 'nms', 'cuda', 'oom', 'ttft', 'moe', 'lora', 'ppo', 'dpo',
              'api', 'url', 'html', 'css', 'json', 'yaml', 'vllm',
              'rpn', 'mae', 'clip', 'vit', 'simclr', 'rlf', 'recsys', 'cag',
              'sgd', 'bpe', 'mha', 'gqa', 'qat', 'mpt', 'sft', 'grpo', 'elo',
              'mcp', 'kpi', 'kpis', 'gpu', 'int', 'fp16', 'fp32', 'int8', 'int16'
          }
          for term in common_acronyms:
              spell.word_frequency.load_words([term])
          
          # Add common ML/technical compound words and terms
          ml_terms = {
              'readme', 'strided', 'softmax', 'covariate', 'overfitting', 'redis', 
              'dataset', 'logit', 'vggnet', 'cifar', 'imagenet', 'resnet', 
              'underperform', 'searchable', 'chatbot', 'workflow', 'agentic', 
              'multi', 'genai', 'bfloat', 'bfloat16', 'relu', 'swiglu', 
              'grokking', 'batchnorm', 'flashattention', 'evals'
          }
          for term in ml_terms:
              spell.word_frequency.load_words([term])
          
          errors = []
          # Find all .md files
          for root, dirs, files in os.walk('.'):
              # Skip hidden directories and build directories
              dirs[:] = [d for d in dirs if not d.startswith('.') and d not in ['node_modules', 'website/_site']]
              
              for file in files:
                  if file.endswith('.md'):
                      filepath = os.path.join(root, file)
                      # Extract words from filename (remove extension, split by spaces/special chars)
                      filename_no_ext = file[:-3]  # Remove .md
                      # Split by common separators
                      words = re.findall(r'[a-zA-Z]+', filename_no_ext.lower())
                      
                      for word in words:
                          # Skip very short words (likely abbreviations or connectors)
                          if len(word) < 3:
                              continue
                          # Skip if it's a number
                          if word.isdigit():
                              continue
                          # Skip common contractions that got split incorrectly
                          if word in ['aren', 'didn', 'won', 'can', 'isn', 'hasn', 'haven', 'wasn', 'weren', 
                                     'wouldn', 'shouldn', 'couldn', 'mightn', 'mustn', 'shan', 'ma', 'o']:
                              continue
                          # Check if word is in technical terms, acronyms, or ML terms (case-insensitive)
                          if word in technical_terms or word in common_acronyms or word in ml_terms:
                              continue
                          # Use spell checker to verify if it's a valid English word
                          # spell.unknown() returns words that are misspelled
                          misspelled = spell.unknown([word])
                          if word in misspelled:
                              # Get suggestions to see if it's a real typo
                              suggestions = list(spell.candidates(word))
                              # Only flag if there are good suggestions (likely a real typo)
                              # Common typos will have close suggestions
                              if suggestions and len(suggestions) > 0:
                                  # Check if any suggestion is close (within 2 character difference)
                                  best_suggestion = min(suggestions, key=lambda x: abs(len(x) - len(word)))
                                  # Flag if the suggestion is significantly different (likely typo)
                                  # But ignore if it's just a technical term variation
                                  char_diff = abs(len(best_suggestion) - len(word))
                                  if char_diff <= 2 and best_suggestion != word:
                                      errors.append(f"‚ö†Ô∏è  Potential spelling issue in filename: {filepath} (word: '{word}' -> suggested: '{best_suggestion}')")
          
          if errors:
              print("\n".join(errors))
              print(f"\n‚ùå Found {len(errors)} potential spelling issues in filenames")
              print("üí° Tip: Add technical terms to .wordlist.txt if they are correct")
              sys.exit(1)
          else:
              print("‚úÖ All filenames passed spelling check")
          EOF

      - name: Spellcheck file contents
        uses: rojopolis/spellcheck-github-actions@0.58.0
        with:
          task_name: Markdown
          config_path: .spellcheck.yml
          source_files: |
            "**/*.md"
            "!node_modules/**"
            "!website/_site/**"
            "!.github/**"

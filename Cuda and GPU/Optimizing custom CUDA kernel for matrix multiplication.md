ğ™ğ™ğ™š ğ™Šğ™˜ğ™˜ğ™ªğ™¥ğ™–ğ™£ğ™˜ğ™® ğ™„ğ™¡ğ™¡ğ™ªğ™¨ğ™ğ™¤ğ™£ ğ™ğ™§ğ™–ğ™¥ ğŸ­

You're in a GPU Optimization interview at NVIDIA. The interviewer presents a custom CUDA kernel for matrix multiplication:

"ğ˜ğ˜¦ ğ˜¢ğ˜³ğ˜¦ ğ˜µğ˜³ğ˜ºğ˜ªğ˜¯ğ˜¨ ğ˜µğ˜° ğ˜°ğ˜±ğ˜µğ˜ªğ˜®ğ˜ªğ˜»ğ˜¦ ğ˜µğ˜©ğ˜ªğ˜´ ğ˜¬ğ˜¦ğ˜³ğ˜¯ğ˜¦ğ˜­. ğ˜Šğ˜¶ğ˜³ğ˜³ğ˜¦ğ˜¯ğ˜µğ˜­ğ˜º, ğ˜ªğ˜µ ğ˜¶ğ˜´ğ˜¦ğ˜´ 64 ğ˜³ğ˜¦ğ˜¨ğ˜ªğ˜´ğ˜µğ˜¦ğ˜³ğ˜´ ğ˜±ğ˜¦ğ˜³ ğ˜µğ˜©ğ˜³ğ˜¦ğ˜¢ğ˜¥, ğ˜¸ğ˜©ğ˜ªğ˜¤ğ˜© ğ˜­ğ˜ªğ˜®ğ˜ªğ˜µğ˜´ ğ˜°ğ˜¶ğ˜³ ğ˜–ğ˜¤ğ˜¤ğ˜¶ğ˜±ğ˜¢ğ˜¯ğ˜¤ğ˜º (ğ˜¢ğ˜¤ğ˜µğ˜ªğ˜·ğ˜¦ ğ˜¸ğ˜¢ğ˜³ğ˜±ğ˜´) ğ˜µğ˜° 50%. ğ˜šğ˜©ğ˜°ğ˜¶ğ˜­ğ˜¥ ğ˜¸ğ˜¦ ğ˜´ğ˜±ğ˜ªğ˜­ğ˜­ ğ˜³ğ˜¦ğ˜¨ğ˜ªğ˜´ğ˜µğ˜¦ğ˜³ğ˜´ ğ˜µğ˜° ğ˜­ğ˜°ğ˜¤ğ˜¢ğ˜­ ğ˜®ğ˜¦ğ˜®ğ˜°ğ˜³ğ˜º ğ˜µğ˜° ğ˜ªğ˜¯ğ˜¤ğ˜³ğ˜¦ğ˜¢ğ˜´ğ˜¦ ğ˜°ğ˜¤ğ˜¤ğ˜¶ğ˜±ğ˜¢ğ˜¯ğ˜¤ğ˜º ğ˜µğ˜° 100%?"

ğŸ—£ï¸ 90% of candidates walk right into the trap.

They say: "ğ˜ ğ˜¦ğ˜´. ğ˜ğ˜ªğ˜¨ğ˜© ğ˜°ğ˜¤ğ˜¤ğ˜¶ğ˜±ğ˜¢ğ˜¯ğ˜¤ğ˜º ğ˜ªğ˜´ ğ˜µğ˜©ğ˜¦ ğ˜¨ğ˜°ğ˜­ğ˜¥ ğ˜´ğ˜µğ˜¢ğ˜¯ğ˜¥ğ˜¢ğ˜³ğ˜¥. ğ˜ğ˜¦ ğ˜¯ğ˜¦ğ˜¦ğ˜¥ ğ˜®ğ˜°ğ˜³ğ˜¦ ğ˜¸ğ˜¢ğ˜³ğ˜±ğ˜´ ğ˜µğ˜° ğ˜©ğ˜ªğ˜¥ğ˜¦ ğ˜®ğ˜¦ğ˜®ğ˜°ğ˜³ğ˜º ğ˜­ğ˜¢ğ˜µğ˜¦ğ˜¯ğ˜¤ğ˜º."

Wrong. You just made the kernel slower.

ğ—§ğ—µğ—² ğ—¥ğ—²ğ—®ğ—¹ğ—¶ğ˜ğ˜†: ğ—¢ğ—°ğ—°ğ˜‚ğ—½ğ—®ğ—»ğ—°ğ˜† ğ—¶ğ˜€ ğ—® ğ—½ğ—¿ğ—¼ğ˜…ğ˜†, ğ—»ğ—¼ğ˜ ğ—® ğ—´ğ—¼ğ—®ğ—¹.

High occupancy hides latency by switching between many warps (Thread-Level Parallelism). However, spilling registers to Local Memory (L1/DRAM) introduces massive latency penalties that no amount of warp switching can hide.

There is a superior way to hide latency: ğ—œğ—»ğ˜€ğ˜ğ—¿ğ˜‚ğ—°ğ˜ğ—¶ğ—¼ğ—»-ğ—Ÿğ—²ğ˜ƒğ—²ğ—¹ ğ—£ğ—®ğ—¿ğ—®ğ—¹ğ—¹ğ—²ğ—¹ğ—¶ğ˜€ğ—º (ğ—œğ—Ÿğ—£).

â€¢ If a single thread issues 4 independent math instructions back-to-back, the hardware pipeline stays busy without needing to switch warps.
 
â€¢ Fewer warps with ğ˜®ğ˜°ğ˜³ğ˜¦ registers (and thus more data kept hot in the register file) often outperform many warps that are starving for registers.
 

âœ… ğ—§ğ—µğ—² ğ—¦ğ—¼ğ—¹ğ˜‚ğ˜ğ—¶ğ—¼ğ—»: ğ—¢ğ—½ğ˜ğ—¶ğ—ºğ—¶ğ˜‡ğ—² ğ—³ğ—¼ğ—¿ ğ—œğ—Ÿğ—£, ğ—»ğ—¼ğ˜ ğ—·ğ˜‚ğ˜€ğ˜ ğ—§ğ—Ÿğ—£.

Don't decrease register usage. Increase the work per thread (Thread Coarsening).

â€¢ Have each thread compute 4 or 8 output elements instead of 1.
 
â€¢ This increases ILP, amortizes the cost of loading data from shared memory, and utilizes the large register file effectively.
 

âœï¸ ğ—§ğ—µğ—² ğ—”ğ—»ğ˜€ğ˜„ğ—²ğ—¿ ğ—§ğ—µğ—®ğ˜ ğ—šğ—²ğ˜ğ˜€ ğ—¬ğ—¼ğ˜‚ ğ—›ğ—¶ğ—¿ğ—²ğ—±:

"ğ˜ğ˜¯ğ˜¤ğ˜³ğ˜¦ğ˜¢ğ˜´ğ˜ªğ˜¯ğ˜¨ ğ˜°ğ˜¤ğ˜¤ğ˜¶ğ˜±ğ˜¢ğ˜¯ğ˜¤ğ˜º ğ˜£ğ˜º ğ˜´ğ˜±ğ˜ªğ˜­ğ˜­ğ˜ªğ˜¯ğ˜¨ ğ˜³ğ˜¦ğ˜¨ğ˜ªğ˜´ğ˜µğ˜¦ğ˜³ğ˜´ ğ˜ªğ˜´ ğ˜¢ ğ˜¯ğ˜¦ğ˜µ ğ˜­ğ˜°ğ˜´ğ˜´. ğ˜›ğ˜©ğ˜¦ ğ˜­ğ˜¢ğ˜µğ˜¦ğ˜¯ğ˜¤ğ˜º ğ˜±ğ˜¦ğ˜¯ğ˜¢ğ˜­ğ˜µğ˜º ğ˜°ğ˜§ ğ˜­ğ˜°ğ˜¤ğ˜¢ğ˜­ ğ˜®ğ˜¦ğ˜®ğ˜°ğ˜³ğ˜º ğ˜ªğ˜´ ğ˜µğ˜°ğ˜° ğ˜©ğ˜ªğ˜¨ğ˜©. ğ˜ ğ˜¸ğ˜°ğ˜¶ğ˜­ğ˜¥ ğ˜ªğ˜¯ğ˜´ğ˜µğ˜¦ğ˜¢ğ˜¥ ğ˜§ğ˜°ğ˜¤ğ˜¶ğ˜´ ğ˜°ğ˜¯ ğ˜ğ˜¯ğ˜´ğ˜µğ˜³ğ˜¶ğ˜¤ğ˜µğ˜ªğ˜°ğ˜¯-ğ˜“ğ˜¦ğ˜·ğ˜¦ğ˜­ ğ˜—ğ˜¢ğ˜³ğ˜¢ğ˜­ğ˜­ğ˜¦ğ˜­ğ˜ªğ˜´ğ˜® (ğ˜ğ˜“ğ˜—). ğ˜‰ğ˜º ğ˜¶ğ˜´ğ˜ªğ˜¯ğ˜¨ ğ˜›ğ˜©ğ˜³ğ˜¦ğ˜¢ğ˜¥ ğ˜Šğ˜°ğ˜¢ğ˜³ğ˜´ğ˜¦ğ˜¯ğ˜ªğ˜¯ğ˜¨ (ğ˜±ğ˜³ğ˜°ğ˜¤ğ˜¦ğ˜´ğ˜´ğ˜ªğ˜¯ğ˜¨ ğ˜®ğ˜¶ğ˜­ğ˜µğ˜ªğ˜±ğ˜­ğ˜¦ ğ˜¦ğ˜­ğ˜¦ğ˜®ğ˜¦ğ˜¯ğ˜µğ˜´ ğ˜±ğ˜¦ğ˜³ ğ˜µğ˜©ğ˜³ğ˜¦ğ˜¢ğ˜¥), ğ˜¸ğ˜¦ ğ˜¤ğ˜¢ğ˜¯ ğ˜©ğ˜ªğ˜¥ğ˜¦ ğ˜­ğ˜¢ğ˜µğ˜¦ğ˜¯ğ˜¤ğ˜º ğ˜·ğ˜ªğ˜¢ ğ˜ªğ˜¯ğ˜¥ğ˜¦ğ˜±ğ˜¦ğ˜¯ğ˜¥ğ˜¦ğ˜¯ğ˜µ ğ˜ªğ˜¯ğ˜´ğ˜µğ˜³ğ˜¶ğ˜¤ğ˜µğ˜ªğ˜°ğ˜¯ ğ˜ªğ˜´ğ˜´ğ˜¶ğ˜¦ ğ˜³ğ˜¢ğ˜µğ˜©ğ˜¦ğ˜³ ğ˜µğ˜©ğ˜¢ğ˜¯ ğ˜¤ğ˜°ğ˜¯ğ˜µğ˜¦ğ˜¹ğ˜µ ğ˜´ğ˜¸ğ˜ªğ˜µğ˜¤ğ˜©ğ˜ªğ˜¯ğ˜¨. ğ˜ˆğ˜´ ğ˜ğ˜°ğ˜­ğ˜¬ğ˜°ğ˜·'ğ˜´ ğ˜³ğ˜¦ğ˜´ğ˜¦ğ˜¢ğ˜³ğ˜¤ğ˜© ğ˜´ğ˜©ğ˜°ğ˜¸ğ˜´, ğ˜­ğ˜°ğ˜¸ğ˜¦ğ˜³ ğ˜°ğ˜¤ğ˜¤ğ˜¶ğ˜±ğ˜¢ğ˜¯ğ˜¤ğ˜º ğ˜¸ğ˜ªğ˜µğ˜© ğ˜©ğ˜ªğ˜¨ğ˜© ğ˜³ğ˜¦ğ˜¨ğ˜ªğ˜´ğ˜µğ˜¦ğ˜³ ğ˜¶ğ˜´ğ˜¢ğ˜¨ğ˜¦ ğ˜°ğ˜§ğ˜µğ˜¦ğ˜¯ ğ˜ºğ˜ªğ˜¦ğ˜­ğ˜¥ğ˜´ ğ˜µğ˜©ğ˜¦ ğ˜©ğ˜ªğ˜¨ğ˜©ğ˜¦ğ˜´ğ˜µ ğ˜µğ˜©ğ˜³ğ˜°ğ˜¶ğ˜¨ğ˜©ğ˜±ğ˜¶ğ˜µ."

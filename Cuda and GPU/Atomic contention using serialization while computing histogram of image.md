ğ™ğ™ğ™š "ğ˜¼ğ™©ğ™¤ğ™¢ğ™ğ™˜" ğ˜½ğ™¤ğ™©ğ™©ğ™¡ğ™šğ™£ğ™šğ™˜ğ˜¬ ğŸ’¥

You're in a High-Performance Computing interview at Meta. The interviewer asks:

"ğ˜ğ˜¦ ğ˜¯ğ˜¦ğ˜¦ğ˜¥ ğ˜µğ˜° ğ˜¤ğ˜°ğ˜®ğ˜±ğ˜¶ğ˜µğ˜¦ ğ˜µğ˜©ğ˜¦ ğ˜©ğ˜ªğ˜´ğ˜µğ˜°ğ˜¨ğ˜³ğ˜¢ğ˜® ğ˜°ğ˜§ ğ˜¢ğ˜¯ ğ˜ªğ˜®ğ˜¢ğ˜¨ğ˜¦ (ğ˜¤ğ˜°ğ˜¶ğ˜¯ğ˜µğ˜ªğ˜¯ğ˜¨ ğ˜§ğ˜³ğ˜¦ğ˜²ğ˜¶ğ˜¦ğ˜¯ğ˜¤ğ˜º ğ˜°ğ˜§ ğ˜±ğ˜ªğ˜¹ğ˜¦ğ˜­ ğ˜·ğ˜¢ğ˜­ğ˜¶ğ˜¦ğ˜´ 0-255). ğ˜ğ˜¦ ğ˜©ğ˜¢ğ˜·ğ˜¦ ğ˜¢ ğ˜¬ğ˜¦ğ˜³ğ˜¯ğ˜¦ğ˜­ ğ˜¸ğ˜©ğ˜¦ğ˜³ğ˜¦ ğ˜¦ğ˜·ğ˜¦ğ˜³ğ˜º ğ˜µğ˜©ğ˜³ğ˜¦ğ˜¢ğ˜¥ ğ˜³ğ˜¦ğ˜¢ğ˜¥ğ˜´ ğ˜¢ ğ˜±ğ˜ªğ˜¹ğ˜¦ğ˜­ ğ˜¢ğ˜¯ğ˜¥ ğ˜¥ğ˜°ğ˜¦ğ˜´ ğšŠğšğš˜ğš–ğš’ğšŒğ™°ğšğš ğ˜µğ˜° ğ˜¢ ğ˜¨ğ˜­ğ˜°ğ˜£ğ˜¢ğ˜­ ğ˜¢ğ˜³ğ˜³ğ˜¢ğ˜º ğ˜ªğ˜¯ ğ˜ğ˜—ğ˜œ ğ˜®ğ˜¦ğ˜®ğ˜°ğ˜³ğ˜º. ğ˜›ğ˜©ğ˜¦ ğ˜¤ğ˜°ğ˜¥ğ˜¦ ğ˜ªğ˜´ ğ˜¤ğ˜°ğ˜³ğ˜³ğ˜¦ğ˜¤ğ˜µ, ğ˜£ğ˜¶ğ˜µ ğ˜ªğ˜µ ğ˜³ğ˜¶ğ˜¯ğ˜´ 100ğ˜¹ ğ˜´ğ˜­ğ˜°ğ˜¸ğ˜¦ğ˜³ ğ˜µğ˜©ğ˜¢ğ˜¯ ğ˜¦ğ˜¹ğ˜±ğ˜¦ğ˜¤ğ˜µğ˜¦ğ˜¥. ğ˜ğ˜©ğ˜º?"

ğŸ—£ï¸ ğŸµğŸ¬% ğ—¼ğ—³ ğ—°ğ—®ğ—»ğ—±ğ—¶ğ—±ğ—®ğ˜ğ—²ğ˜€ ğ˜„ğ—®ğ—¹ğ—¸ ğ—¿ğ—¶ğ—´ğ—µğ˜ ğ—¶ğ—»ğ˜ğ—¼ ğ˜ğ—µğ—² ğ˜ğ—¿ğ—®ğ—½.

They say: "ğ˜ğ˜­ğ˜°ğ˜£ğ˜¢ğ˜­ ğ˜®ğ˜¦ğ˜®ğ˜°ğ˜³ğ˜º ğ˜ªğ˜´ ğ˜´ğ˜­ğ˜°ğ˜¸. ğ˜ ğ˜°ğ˜¶ ğ˜´ğ˜©ğ˜°ğ˜¶ğ˜­ğ˜¥ ğ˜±ğ˜¶ğ˜µ ğ˜µğ˜©ğ˜¦ ğ˜©ğ˜ªğ˜´ğ˜µğ˜°ğ˜¨ğ˜³ğ˜¢ğ˜® ğ˜¢ğ˜³ğ˜³ğ˜¢ğ˜º ğ˜ªğ˜¯ ğ˜šğ˜©ğ˜¢ğ˜³ğ˜¦ğ˜¥ ğ˜”ğ˜¦ğ˜®ğ˜°ğ˜³ğ˜º ğ˜§ğ˜ªğ˜³ğ˜´ğ˜µ."

You are getting warmer, but you missed the ğ˜¤ğ˜°ğ˜¯ğ˜µğ˜¦ğ˜¯ğ˜µğ˜ªğ˜°ğ˜¯.

ğ—§ğ—µğ—² ğ—¥ğ—²ğ—®ğ—¹ğ—¶ğ˜ğ˜†: ğ—¦ğ—²ğ—¿ğ—¶ğ—®ğ—¹ğ—¶ğ˜‡ğ—®ğ˜ğ—¶ğ—¼ğ—».

Even in Shared Memory, ğšŠğšğš˜ğš–ğš’ğšŒğ™°ğšğš locks the address.

â€¢ If you have an image of a blue sky, millions of pixels have the value "200".
 
â€¢ Millions of threads try to update ğšŠğšğšğš›ğšğšœğšœ[ğŸ¸ğŸ¶ğŸ¶] at the same exact time.
 
â€¢ The hardware forces them to get in line. You have turned a massively parallel GPU into a ğ˜€ğ—¶ğ—»ğ—´ğ—¹ğ—²-ğ˜ğ—µğ—¿ğ—²ğ—®ğ—±ğ—²ğ—± ğ˜€ğ—²ğ—¾ğ˜‚ğ—²ğ—»ğ˜ğ—¶ğ—®ğ—¹ ğ—½ğ—¿ğ—¼ğ—°ğ—²ğ˜€ğ˜€ğ—¼ğ—¿ for that address.
 

âœ… ğ—§ğ—µğ—² ğ—¦ğ—¼ğ—¹ğ˜‚ğ˜ğ—¶ğ—¼ğ—»: ğ—›ğ—¶ğ—²ğ—¿ğ—®ğ—¿ğ—°ğ—µğ—¶ğ—°ğ—®ğ—¹ ğ—¥ğ—²ğ—±ğ˜‚ğ—°ğ˜ğ—¶ğ—¼ğ—» (ğ—£ğ—¿ğ—¶ğ˜ƒğ—®ğ˜ğ—¶ğ˜‡ğ—®ğ˜ğ—¶ğ—¼ğ—»).

You need to reduce contention layers.

1. ğ—ªğ—®ğ—¿ğ—½-ğ—Ÿğ—²ğ˜ƒğ—²ğ—¹: Use __ğšœğš‘ğšğš•_ğšğš˜ğš ğš—_ğšœğš¢ğš—ğšŒ (warp shuffle) to let threads combine their values ğ˜ªğ˜¯ ğ˜³ğ˜¦ğ˜¨ğ˜ªğ˜´ğ˜µğ˜¦ğ˜³ğ˜´ without locking memory.
 
2. ğ—•ğ—¹ğ—¼ğ—°ğ—¸-ğ—Ÿğ—²ğ˜ƒğ—²ğ—¹: The first thread of the warp does ğ˜°ğ˜¯ğ˜¦ atomic add to Shared Memory.
 
3. ğ—šğ—¿ğ—¶ğ—±-ğ—Ÿğ—²ğ˜ƒğ—²ğ—¹: Only once the block is done, do you atomic add to Global Memory.
 

You replace 1,000,000 global collisions with 1 global collision.

âœï¸ ğ—§ğ—µğ—² ğ—”ğ—»ğ˜€ğ˜„ğ—²ğ—¿ ğ—§ğ—µğ—®ğ˜ ğ—šğ—²ğ˜ğ˜€ ğ—¬ğ—¼ğ˜‚ ğ—›ğ—¶ğ—¿ğ—²ğ—±: 
"ğ˜›ğ˜©ğ˜¦ ğ˜£ğ˜°ğ˜µğ˜µğ˜­ğ˜¦ğ˜¯ğ˜¦ğ˜¤ğ˜¬ ğ˜ªğ˜´ ğ˜¢ğ˜µğ˜°ğ˜®ğ˜ªğ˜¤ ğ˜¤ğ˜°ğ˜¯ğ˜µğ˜¦ğ˜¯ğ˜µğ˜ªğ˜°ğ˜¯ ğ˜¤ğ˜¢ğ˜¶ğ˜´ğ˜ªğ˜¯ğ˜¨ ğ˜´ğ˜¦ğ˜³ğ˜ªğ˜¢ğ˜­ğ˜ªğ˜»ğ˜¢ğ˜µğ˜ªğ˜°ğ˜¯. ğ˜›ğ˜©ğ˜³ğ˜¦ğ˜¢ğ˜¥ğ˜´ ğ˜¢ğ˜³ğ˜¦ ğ˜§ğ˜ªğ˜¨ğ˜©ğ˜µğ˜ªğ˜¯ğ˜¨ ğ˜§ğ˜°ğ˜³ ğ˜µğ˜©ğ˜¦ ğ˜´ğ˜¢ğ˜®ğ˜¦ ğ˜®ğ˜¦ğ˜®ğ˜°ğ˜³ğ˜º ğ˜¢ğ˜¥ğ˜¥ğ˜³ğ˜¦ğ˜´ğ˜´. ğ˜ ğ˜¸ğ˜°ğ˜¶ğ˜­ğ˜¥ ğ˜ªğ˜®ğ˜±ğ˜­ğ˜¦ğ˜®ğ˜¦ğ˜¯ğ˜µ ğ˜ğ˜ªğ˜¦ğ˜³ğ˜¢ğ˜³ğ˜¤ğ˜©ğ˜ªğ˜¤ğ˜¢ğ˜­ ğ˜™ğ˜¦ğ˜¥ğ˜¶ğ˜¤ğ˜µğ˜ªğ˜°ğ˜¯. ğ˜ğ˜ªğ˜³ğ˜´ğ˜µ, ğ˜¶ğ˜´ğ˜¦ ğ˜ğ˜¢ğ˜³ğ˜± ğ˜šğ˜©ğ˜¶ğ˜§ğ˜§ğ˜­ğ˜¦ğ˜´ ğ˜µğ˜° ğ˜¢ğ˜¨ğ˜¨ğ˜³ğ˜¦ğ˜¨ğ˜¢ğ˜µğ˜¦ ğ˜¤ğ˜°ğ˜¶ğ˜¯ğ˜µğ˜´ ğ˜¸ğ˜ªğ˜µğ˜©ğ˜ªğ˜¯ ğ˜¢ ğ˜¸ğ˜¢ğ˜³ğ˜± (ğ˜³ğ˜¦ğ˜¨ğ˜ªğ˜´ğ˜µğ˜¦ğ˜³-ğ˜­ğ˜¦ğ˜·ğ˜¦ğ˜­). ğ˜›ğ˜©ğ˜¦ğ˜¯, ğ˜±ğ˜¦ğ˜³ğ˜§ğ˜°ğ˜³ğ˜® ğ˜¢ ğ˜´ğ˜ªğ˜¯ğ˜¨ğ˜­ğ˜¦ ğ˜¢ğ˜µğ˜°ğ˜®ğ˜ªğ˜¤ ğ˜¢ğ˜¥ğ˜¥ ğ˜±ğ˜¦ğ˜³ ğ˜¸ğ˜¢ğ˜³ğ˜± ğ˜ªğ˜¯ğ˜µğ˜° ğ˜šğ˜©ğ˜¢ğ˜³ğ˜¦ğ˜¥ ğ˜”ğ˜¦ğ˜®ğ˜°ğ˜³ğ˜º. ğ˜ğ˜ªğ˜¯ğ˜¢ğ˜­ğ˜­ğ˜º, ğ˜§ğ˜­ğ˜¶ğ˜´ğ˜© ğ˜µğ˜©ğ˜¦ ğ˜šğ˜©ğ˜¢ğ˜³ğ˜¦ğ˜¥ ğ˜”ğ˜¦ğ˜®ğ˜°ğ˜³ğ˜º ğ˜µğ˜° ğ˜ğ˜­ğ˜°ğ˜£ğ˜¢ğ˜­ ğ˜”ğ˜¦ğ˜®ğ˜°ğ˜³ğ˜º ğ˜°ğ˜¯ğ˜¤ğ˜¦ ğ˜±ğ˜¦ğ˜³ ğ˜£ğ˜­ğ˜°ğ˜¤ğ˜¬. ğ˜›ğ˜©ğ˜ªğ˜´ ğ˜¦ğ˜­ğ˜ªğ˜®ğ˜ªğ˜¯ğ˜¢ğ˜µğ˜¦ğ˜´ 97% ğ˜°ğ˜§ ğ˜µğ˜©ğ˜¦ ğ˜¢ğ˜µğ˜°ğ˜®ğ˜ªğ˜¤ ğ˜¤ğ˜°ğ˜­ğ˜­ğ˜ªğ˜´ğ˜ªğ˜°ğ˜¯ğ˜´."
